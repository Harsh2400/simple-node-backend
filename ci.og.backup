name: ci
on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm test
      - run: npm run build

---------------Debugged Final Pipeline-----------

name: ci
on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read
  id-token: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint --if-present
      - run: npm test --if-present
      - run: npm run build --if-present

  deploy:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build-test
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      ARTIFACT_BUCKET: ${{ vars.ARTIFACT_BUCKET }}
      PARAM_PATH: ${{ vars.PARAM_PATH }}
      APP_DIR: ${{ vars.APP_DIR }}
      SERVICE_PORT: ${{ vars.SERVICE_PORT }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run build --if-present

      - name: Create release zip
        run: |
          mkdir -p artifact
          cp -r dist package.json package-lock.json ecosystem.config.js artifact/
          cd artifact && zip -r ../release.zip . && cd -
          echo "S3_KEY=releases/$(git rev-parse --short HEAD).zip" >> $GITHUB_ENV

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::390847198265:role/GitHubActionsDeployer
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload artifact to S3
        run: aws s3 cp release.zip "s3://${{ env.ARTIFACT_BUCKET }}/${{ env.S3_KEY }}"

      - name: Resolve instance IDs by tags
        id: ids
        run: |
          IDS=$(aws ec2 describe-instances \
            --filters "Name=tag:App,Values=simple-node-backend" "Name=tag:Env,Values=prod" "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].InstanceId" --output text)
          if [ -z "$IDS" ]; then echo "❌ No running instances matched"; exit 1; fi
          echo "ids=$IDS" >> $GITHUB_OUTPUT

      - name: Bootstrap prerequisites on instance (Ubuntu)
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Role,Values=simple-node-backend" \
            --comment "Bootstrap prerequisites" \
            --parameters 'commands=["/bin/bash -c \"set -eu; \
              export DEBIAN_FRONTEND=noninteractive; \
              mkdir -p '"${APP_DIR}"'/releases; \
              apt-get update -y; \
              apt-get install -y curl ca-certificates gnupg unzip; \
              if ! command -v node >/dev/null 2>&1; then \
                curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && apt-get install -y nodejs; \
              fi; \
              if ! command -v pm2 >/dev/null 2>&1; then \
                npm i -g pm2; \
              fi\""]' >/dev/null

      - name: Upload deploy script to S3
        run: aws s3 cp deploy/ssm-deploy.sh "s3://${ARTIFACT_BUCKET}/releases/ssm-deploy.sh"

      - name: Trigger SSM deploy (tags)
        id: ssm
        run: |
          CMD_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Role,Values=simple-node-backend" \
            --comment "Deploy ${{ env.S3_KEY }}" \
            --parameters 'commands=["/bin/bash -c \"set -eu; \
              mkdir -p /opt/tmp && cd /opt/tmp; \
              aws s3 cp s3://'${ARTIFACT_BUCKET}'/releases/ssm-deploy.sh /opt/tmp/ssm-deploy.sh; \
              chmod +x /opt/tmp/ssm-deploy.sh; \
              /opt/tmp/ssm-deploy.sh '"${ARTIFACT_BUCKET}"' '"${S3_KEY}"' '"${PARAM_PATH}"' '"${APP_DIR}"' '"${SERVICE_PORT}"'\""]' \
            --query "Command.CommandId" --output text)
          echo "cmd=$CMD_ID" >> $GITHUB_OUTPUT

      - name: Wait and verify per instance
        run: |
          for ID in ${{ steps.ids.outputs.ids }}; do
            echo "⏳ Waiting for deploy on $ID ..."
            aws ssm wait command-executed --command-id "${{ steps.ssm.outputs.cmd }}" --instance-id "$ID"
            STATUS=$(aws ssm get-command-invocation --command-id "${{ steps.ssm.outputs.cmd }}" --instance-id "$ID" --query "Status" --output text)
            echo "$ID => $STATUS"
            test "$STATUS" = "Success"
          done

-----------------          